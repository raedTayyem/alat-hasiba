name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deployment.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

      - name: Run linter
        run: npm run lint

      - name: Build production bundle
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "Error: dist directory not found"
            exit 1
          fi
          echo "Build output verified"
          du -sh dist/*

      - name: Generate build info
        run: |
          cat > dist/build-info.json << EOF
          {
            "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow": "${{ github.workflow }}",
            "runNumber": "${{ github.run_number }}"
          }
          EOF

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment_gh_pages
        uses: peaceiris/actions-gh-pages@v3
        if: vars.DEPLOY_TARGET == 'github-pages' || vars.DEPLOY_TARGET == ''
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: ${{ vars.CUSTOM_DOMAIN }}
          enable_jekyll: false
          force_orphan: true
          commit_message: 'Deploy ${{ github.sha }}'

      # Deploy to Netlify
      - name: Deploy to Netlify
        id: deployment_netlify
        if: vars.DEPLOY_TARGET == 'netlify'
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: './dist'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from GitHub Actions - ${{ github.sha }}'
          enable-pull-request-comment: false
          enable-commit-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # Deploy to Vercel
      - name: Deploy to Vercel
        id: deployment_vercel
        if: vars.DEPLOY_TARGET == 'vercel'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: '--prod'

      # Deploy to custom hosting (FTP/SFTP)
      - name: Deploy to Custom Hosting via FTP
        id: deployment_ftp
        if: vars.DEPLOY_TARGET == 'ftp'
        uses: SamKirkland/FTP-Deploy-Action@v4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: ${{ vars.FTP_SERVER_DIR || '/' }}

      # Deploy to AWS S3
      - name: Deploy to AWS S3
        id: deployment_s3
        if: vars.DEPLOY_TARGET == 's3'
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: --delete --follow-symlinks
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
          SOURCE_DIR: 'dist'

      # Invalidate CloudFront cache if using AWS
      - name: Invalidate CloudFront
        if: vars.DEPLOY_TARGET == 's3' && secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID != ''
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }}
          PATHS: '/*'
          AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Set deployment URL
        id: deployment
        run: |
          DEPLOY_TARGET="${{ vars.DEPLOY_TARGET }}"

          case "$DEPLOY_TARGET" in
            github-pages)
              echo "url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
              ;;
            netlify)
              echo "url=${{ steps.deployment_netlify.outputs.deploy-url }}" >> $GITHUB_OUTPUT
              ;;
            vercel)
              echo "url=${{ steps.deployment_vercel.outputs.preview-url }}" >> $GITHUB_OUTPUT
              ;;
            ftp)
              echo "url=${{ vars.PRODUCTION_URL }}" >> $GITHUB_OUTPUT
              ;;
            s3)
              echo "url=${{ vars.PRODUCTION_URL }}" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-deployment-${{ github.sha }}
          path: dist/
          retention-days: 90

      - name: Create deployment summary
        run: |
          echo "## Deployment Successful! üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed to:** ${{ vars.DEPLOY_TARGET || 'github-pages' }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deployment.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Stats" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -sh dist/* >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Deployment Status
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ needs.deploy.result == 'success' && '‚úÖ' || '‚ùå' }} Deployment ${{ needs.deploy.result }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ needs.deploy.result == 'success' && '‚úÖ Deployment successful!' || '‚ùå Deployment failed!' }}\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}

      - name: Create GitHub release
        if: needs.deploy.result == 'success' && vars.AUTO_RELEASE == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release ${{ github.run_number }}
          body: |
            Automated deployment from commit ${{ github.sha }}

            Deployed to: ${{ vars.DEPLOY_TARGET || 'github-pages' }}
          draft: false
          prerelease: false
